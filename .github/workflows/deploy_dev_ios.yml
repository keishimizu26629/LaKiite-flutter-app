name: "[Release] Dev iOS"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45
    environment: dev

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup CI
        uses: ./.github/actions/setup

      - name: Restore Firebase config files
        run: |
          echo "${{ secrets.DEV_GOOGLESERVICE_INFO_PLIST_BASE64 }}" | base64 -d > ios/Runner/GoogleService-Info.plist

      - name: Restore dart-define config
        run: |
          echo "${{ secrets.DEV_DART_DEFINE_JSON_BASE64 }}" | base64 -d > dart_define/dev_dart_define.json

      - name: Setup Provisioning Profile Directory
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Deploy with fastlane (unified with local)
        env:
          # 証明書設定
          CERT_PWD: ${{ secrets.CERT_PWD }}
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}

          # App Store Connect API設定
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_BASE64: ${{ secrets.ASC_API_KEY_BASE64 }}

          # プロビジョニング設定
          DEV_BUNDLE_ID: ${{ secrets.DEV_BUNDLE_ID }}
          DEV_PROVISIONING_PROFILE_NAME: ${{ secrets.DEV_PROVISIONING_PROFILE_NAME }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.DEV_PROVISIONING_PROFILE_BASE64 }}
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
          IPA_OUTPUT_NAME: ${{ secrets.IPA_OUTPUT_NAME }}

          # CI環境設定
          FASTLANE_DISABLE_PTY: 1
          FASTLANE_EXPLICIT_OPEN3: 1
          FASTLANE_DISABLE_COLORS: 1
          CI: 1
        run: |
          cd ios
          fastlane dev
