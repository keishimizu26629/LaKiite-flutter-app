name: "[Release] Dev iOS"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45
    environment: dev

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Xcode version
        run: |
          xcode-select -p
          xcodebuild -version
          echo "Using default Xcode for Xcode 16 compatibility"

      - name: Setup CI
        uses: ./.github/actions/setup

      - name: Restore Firebase config files
        run: |
          echo "${{ secrets.DEV_GOOGLESERVICE_INFO_PLIST_BASE64 }}" | base64 -d > ios/Runner/GoogleService-Info.plist
          echo "${{ secrets.FIREBASE_OPTIONS_DART_BASE64 }}" | base64 -d > lib/firebase_options.dart

      - name: Restore dart-define config
        run: |
          echo "${{ secrets.DEV_DART_DEFINE_JSON_BASE64 }}" | base64 -d > dart_define/dev_dart_define.json

      - name: Setup Provisioning Profile Directory
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Clean iOS build cache and update dependencies
        run: |
          cd ios
          # Clean all caches for fresh dependency resolution
          rm -rf Pods
          rm -rf Podfile.lock
          rm -rf build
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          # Clean CocoaPods cache for latest Firebase/gRPC
          pod cache clean --all
          echo "Cleaned all caches for iOS 15.0 and Firebase SDK 12.4.0 compatibility"

      - name: Debug certificates and provisioning profiles
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.DEV_PROVISIONING_PROFILE_BASE64 }}
          DEV_PROVISIONING_PROFILE_NAME: ${{ secrets.DEV_PROVISIONING_PROFILE_NAME }}
        run: |
          echo "=== Certificate and Provisioning Profile Debug ==="
          
          # Check available certificates in system keychain
          echo "üìã System keychain certificates:"
          security find-identity -v -p codesigning | head -10 || true
          
          # Check if we have the certificate data
          if [ ! -z "$IOS_CERTIFICATE_BASE64" ]; then
            echo "‚úÖ IOS_CERTIFICATE_BASE64 is set (length: ${#IOS_CERTIFICATE_BASE64})"
          else
            echo "‚ùå IOS_CERTIFICATE_BASE64 is not set"
          fi
          
          # Check if we have the provisioning profile data
          if [ ! -z "$PROVISIONING_PROFILE_BASE64" ]; then
            echo "‚úÖ PROVISIONING_PROFILE_BASE64 is set (length: ${#PROVISIONING_PROFILE_BASE64})"
          else
            echo "‚ùå PROVISIONING_PROFILE_BASE64 is not set"
          fi
          
          echo "üì± Expected provisioning profile name: $DEV_PROVISIONING_PROFILE_NAME"
          
          # Check existing provisioning profiles
          echo "üìÑ Existing provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || echo "No provisioning profiles directory found"

      - name: Deploy with fastlane (unified with local)
        env:
          # Ë®ºÊòéÊõ∏Ë®≠ÂÆö
          CERT_PWD: ${{ secrets.CERT_PWD }}
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}

          # App Store Connect APIË®≠ÂÆö
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_BASE64: ${{ secrets.ASC_API_KEY_BASE64 }}

          # „Éó„É≠„Éì„Ç∏„Éß„Éã„É≥„Ç∞Ë®≠ÂÆö
          DEV_BUNDLE_ID: ${{ secrets.DEV_BUNDLE_ID }}
          DEV_PROVISIONING_PROFILE_NAME: ${{ secrets.DEV_PROVISIONING_PROFILE_NAME }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.DEV_PROVISIONING_PROFILE_BASE64 }}
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
          IPA_OUTPUT_NAME: ${{ secrets.IPA_OUTPUT_NAME }}

          # CIÁí∞Â¢ÉË®≠ÂÆö
          FASTLANE_DISABLE_PTY: 1
          FASTLANE_EXPLICIT_OPEN3: 1
          FASTLANE_DISABLE_COLORS: 1
          CI: 1
        run: |
          cd ios
          fastlane dev

      - name: Debug build settings on failure
        if: failure()
        run: |
          echo "=== Xcode Build Settings Debug ==="
          cd ios
          xcodebuild -showBuildSettings -workspace Runner.xcworkspace -scheme Runner -configuration Release-dev | tail -n 50 || true
          echo "=== Gym Log Tail ==="
          tail -n 200 /Users/runner/Library/Logs/gym/Runner-Runner.log || true
          echo "=== Build Logs Directory ==="
          ls -la ./build/logs/ || true

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: |
            /Users/runner/Library/Logs/gym/Runner-Runner.log
            ios/build/logs/
          retention-days: 7
