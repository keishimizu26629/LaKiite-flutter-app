# Flutter アプリ開発前提条件・要件定義

## 概要

本アプリは、ユーザー同士で予定を共有し、プライベートリストを活用してスケジュール管理を円滑にすることを目的としています。バックエンドには Firebase を利用し、Flutter でフロントエンドを構築します。また、予定に対するいいねやコメントなどのソーシャル機能も提供し、ユーザー間のインタラクションを促進します。

---

## 実現したい内容

1. **ユーザー同士の予定共有**

   - ユーザー同士は「友人」になることで、お互いの友人リストに表示される。
   - 共有はプライベートリスト単位で可能。
   - 予定に対していいねやコメントが可能。

2. **プライベートリスト管理**

   - ユーザーは任意のプライベートリストを作成できる。
   - 作成したリストに友人を招待・追加することができる。
   - リストには説明文やアイコンを設定可能。

3. **予定登録**

   - 予定には「タイトル」「説明」「場所」「日時」を入力可能。
   - 登録する予定をどのリストに公開するかを選択できる。
   - 予定に対する説明文を追加可能。

4. **カレンダー表示**

   - Google Calendar ライクな月次カレンダー表示。
   - 日付セルをタップして日次表示に遷移可能。
   - 日次表示では時間軸で予定を表示。
   - 予定を作成したユーザーが「誰で」「どのリストで」公開しているかを確認できる。

5. **ソーシャル機能**
   - 予定に対していいねを付けることが可能。
   - 予定にコメントを追加可能。
   - いいねとコメントはリアルタイムで更新。

---

## 技術スタック

- **フロントエンド**: Flutter
- **バックエンド**: Firebase (Authentication, Firestore, Cloud Functions など)

---

## データ設計

### 1. コレクション・ドキュメント構造 (Firestore)

以下の例は、最小限のフィールドを想定したサンプルです。実際の実装では必要に応じてフィールドを追加してください。

#### users コレクション

- **`users/{userId}`**

  - ドキュメント ID: `userId` (Firebase Auth UID)
  - フィールド (公開情報):

    - `displayName`: ユーザーの表示名
    - `searchId`: ユーザー検索用 ID
    - `iconUrl`: プロフィール画像の URL (オプション)

  - サブコレクション:
    - **`private/profile`** (非公開情報)
      - フィールド:
        - `name`: ユーザーの基本名
        - `friends`: 友人のユーザー ID リスト (配列)
        - `lists`: 所属リストの ID リスト (配列)
        - `createdAt`: アカウント作成日時

  データアクセス制御:

  - 公開情報 (`users/{userId}`): 認証済みユーザーなら誰でも読み取り可能
  - 非公開情報 (`users/{userId}/private/profile`): 本人のみ読み書き可能

#### lists コレクション

- **`lists`**
  - ドキュメント ID: `listId`
  - フィールド例:
    - `listName`: リスト名
    - `ownerId`: リストを作成したユーザー ID
    - `memberIds`: リストに所属するユーザー ID リスト (配列)
    - `createdAt`: 作成日時 (timestamp)
    - `iconUrl`: リストのアイコン URL (オプション)
    - `description`: リストの説明文 (オプション)

#### schedules コレクション

- **`schedules`**

  - ドキュメント ID: `scheduleId`
  - フィールド例:

    - `title`: 予定のタイトル
    - `description`: 予定の説明
    - `location`: 場所（オプション）
    - `dateTime`: 予定の日時 (timestamp)
    - `ownerId`: 予定を作成したユーザー ID
    - `listId`: 予定を公開するリスト ID
    - `createdAt`: 予定の作成日時
    - `updatedAt`: 予定の更新日時

  - サブコレクション:

    - **`likes`**: いいねの管理

      - ドキュメント ID: `userId`（いいねしたユーザーの ID）
      - フィールド:
        - `userId`: いいねしたユーザーの ID
        - `createdAt`: いいねした日時

    - **`comments`**: コメントの管理
      - ドキュメント ID: 自動生成
      - フィールド:
        - `userId`: コメントしたユーザーの ID
        - `content`: コメント内容
        - `createdAt`: コメントした日時
        - `userDisplayName`: コメントしたユーザーの表示名
        - `userPhotoUrl`: コメントしたユーザーのアイコン URL（オプション）

### 2. リレーション例

- **ユーザー** は複数の **プライベートリスト** に所属可能。
  → `lists.memberIds` に `userId` が含まれる。
- **ユーザー** は複数の **友人** を持つ。
  → `users.friendIds` に他の `userId` を追加。
- **リスト** は複数の **スケジュール (予定)** を持つ。
  → `schedules.listId` で管理。
- **ユーザー** は複数の **スケジュール** を作成可能。
  → `schedules.ownerId` で管理。
- **スケジュール** は複数の **いいね** と **コメント** を持つ。
  → サブコレクションで管理。

---

## 機能概要

1. **ユーザー登録・ログイン (Firebase Authentication)**

   - メールアドレス・パスワード認証や SNS 連携などを想定。

2. **友人管理**

   - 検索 (メールアドレスやユーザー ID など) → 友人リクエスト → 相互フォロー状態で「友人」確定。
   - `users.friendIds` に相手の `userId` を追加。

3. **プライベートリスト作成・管理**

   - リスト名とメンバーを指定して作成。
   - 説明文やアイコンの設定が可能。
   - 既存メンバーによるリストへの追加招待。
   - `lists` コレクションでリスト情報を管理。

4. **予定作成・管理**

   - タイトル・説明・場所・日時を入力。
   - 公開するリストを選択。
   - `schedules` コレクションで管理。

5. **カレンダー表示**

   - Google Calendar ライクな月次表示。
   - 日付セルをタップして日次表示に遷移。
   - 日次表示では時間軸で予定を表示。
   - 予定作成者と公開リストの情報も表示。

6. **予定へのインタラクション**
   - いいねの追加・削除。
   - コメントの投稿・表示。
   - リアルタイムでの更新。

---

## 画面構成

1. **ログイン画面**
2. **ホーム画面 (カレンダー表示)**
   - 月次カレンダー
   - 日次カレンダー
3. **友人管理画面**
4. **リスト管理画面**
   - リスト作成
   - メンバー招待
   - リスト設定
5. **予定作成画面**
6. **予定詳細画面**
   - 予定の基本情報表示
   - いいね・コメント機能
   - 作成者情報

---

## 実装におけるポイント

- **リアルタイム更新**:

  - Firestore のリアルタイムリスナーを使用。
  - スケジュール、いいね、コメントをリアルタイムに反映。

- **セキュリティルール**:

  - **ユーザーデータのアクセス制御**:
    - 公開情報: 認証済みユーザーなら誰でも読み取り可能
    - 非公開情報: 本人のみ読み書き可能
  - **リストとスケジュール**:
    - リスト: メンバーのみ読み取り可能、オーナーのみ更新可能
    - スケジュール: リストメンバーのみアクセス可能
    - いいね・コメント: リストメンバーのみ追加・閲覧可能

- **日付や時間の管理**:

  - Firestore には Timestamp 型を使用。
  - Flutter 側で適切に変換・表示。
  - タイムゾーンの扱いも考慮。

- **カレンダー実装**:
  - 独自のカレンダーウィジェットを実装。
  - 月次・日次表示の切り替え。
  - スケジュールの視覚的な表示。

---

## 今後のステップ

1. **画面設計 (UI/UX)**
   - 各画面のレイアウト、遷移フローを決定。
2. **Firebase プロジェクトの設定**
   - Authentication, Firestore, Storage, Cloud Functions の準備。
3. **Flutter プロジェクトの立ち上げ**
   - 基本的なディレクトリ構成の決定、依存パッケージの導入。
4. **データベース周りの実装**
   - Firestore のデータ構造に合わせて CRUD 処理を実装。
5. **テスト & デバッグ**
   - エミュレーターやステージング環境を使って検証。
6. **リリース準備**
   - アプリストア (iOS/Android) の申請要件を満たすようにビルドや審査対応。

---

## コード修正とバージョン管理

コードを修正した後は、変更を適切に管理するために以下の手順を必ず実行してください：

1. **変更ファイルの確認**

   ```bash
   git status
   ```

2. **変更内容の確認**

   ```bash
   git diff [ファイル名]
   ```

3. **変更をステージングに追加**

   ```bash
   git add [ファイル名]
   ```

4. **同じ目的の修正は一つのコミットにまとめる**

   ```bash
   git commit -m "英語でコミットメッセージを記述する"
   ```

5. **コミットメッセージは変更内容を明確に説明する**

   - バグ修正: "Fix notification read status not updating"
   - 機能追加: "Add user profile image display in friend search"
   - リファクタリング: "Refactor notification handling for better error management"

6. **大きな変更は複数の小さなコミットに分ける**
   - 関連する変更ごとに個別のコミットを作成
   - それぞれのコミットが独立して機能することを確認

以上が本アプリの基本的な要件とデータ設計の概要です。Firebase を活用したリアルタイムデータベース機能を中心に、ユーザーの友人・プライベートリスト管理とスケジュールの共有機能、そしてソーシャル機能を実装していきます。

## Firebase 関連ファイル構成

Firebase 関連のファイル（Security Rules や Cloud Functions）は、別リポジトリで管理されています：

```
/Users/keisukeshimizu/Development/FlutterApps/LaKiite/lakiite-firebase-commons/
├── firestore.rules     # Firestoreのセキュリティルール
├── storage.rules       # Cloud Storageのセキュリティルール
└── functions/         # Cloud Functions
    ├── src/           # TypeScriptソースコード
    ├── lib/           # コンパイル後のJavaScriptコード
    ├── package.json   # 依存関係の管理
    └── tsconfig.json  # TypeScript設定
```

このリポジトリでの変更は、必ず Flutter アプリ側の実装と整合性を取るようにしてください。特に以下の点に注意が必要です：

1. **Security Rules の変更**:

   - アプリ側のデータアクセスパターンと一致していることを確認
   - テストケースを追加・更新

2. **Cloud Functions の変更**:
   - アプリ側の呼び出しインターフェースと互換性を維持
   - エラーハンドリングの整合性を確保
   - ログ出力を適切に設定
